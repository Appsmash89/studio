
# SpinRiches Casino - Project Documentation

## 1. Project Overview

**SpinRiches Casino** is a sophisticated, web-based "Wheel of Fortune" style game built with a modern technology stack. It features a main spinning wheel, a Top Slot multiplier, four distinct bonus games, a dynamic betting interface, and user authentication. The project is designed to be highly customizable, performant, and extensible, with support for native mobile deployment via Capacitor.

---

## 2. Technology Stack

- **Framework**: [Next.js](https://nextjs.org/) (App Router)
- **Language**: [TypeScript](https://www.typescriptlang.org/)
- **UI Library**: [React](https://reactjs.org/)
- **Styling**: [Tailwind CSS](https://tailwindcss.com/)
- **UI Components**: [ShadCN/UI](https://ui.shadcn.com/)
- **Authentication**: [Firebase Authentication](https://firebase.google.com/docs/auth)
- **Database**: [Cloud Firestore](https://firebase.google.com/docs/firestore) for user data persistence.
- **AI Integration**: [Genkit](https://firebase.google.com/docs/genkit)
- **Client-Side Storage**: [IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API) via the `idb` library for asset caching.
- **Sound**: [Tone.js](https://tonejs.github.io/) for synthesized sound effects.
- **Mobile Deployment**: [Capacitor](https://capacitorjs.com/) for building native mobile apps.

---

## 3. Architecture & File Structure

The project follows a feature-oriented structure within the Next.js App Router paradigm.

-   `src/app/`: Core application pages and layout.
    -   `page.tsx`: The main entry point. It manages authentication, asset loading, and renders the main `Game` component or `Login` screen.
    -   `game.tsx`: The central component orchestrating the entire game. It holds the primary game state, logic, and timers.
    -   `layout.tsx`: The root layout for the application, importing global styles, fonts, and wrapping children with the `AuthProvider`.
    -   `globals.css`: Defines global styles, Tailwind CSS layers, and the application's color theme via CSS variables (HSL).
    -   `layout-guide/page.tsx`: A developer-facing visual guide that maps component names to their UI locations.
-   `src/components/`: Reusable React components.
    -   `ui/`: Base components generated by ShadCN/UI (e.g., `Button`, `Card`).
    -   `bonus/`: Self-contained components for each of the four bonus games (`CashHuntBonus`, `CoinFlipBonus`, `CrazyTimeBonus`, `PachinkoBonus`).
    -   `game/`: Components directly related to the core game interface (`Wheel`, `BettingInterface`, `GameHistory`, `GameHeader`).
    -   `dev/`: The `DevTools` component, providing debugging and testing controls.
    -   `login.tsx`: The UI for user sign-in.
    -   `top-slot.tsx`: The component for the Top Slot multiplier reel animation.
-   `src/contexts/`: React Context providers.
    -   `auth-context.tsx`: Manages user authentication state, including guest mode and user data persistence.
-   `src/lib/`: Utility functions and libraries.
    -   `firebase.ts`: Initializes the Firebase app, auth, and Firestore services. Handles Firebase configuration and errors.
    -   `asset-manager.ts`: A custom class to manage downloading and caching game assets in IndexedDB.
    -   `data-generator.ts`: A utility to generate simulated game log data for testing and analysis.
    -   `user-data-service.ts`: A dedicated service to handle all Firestore database operations for user data (e.g., getting/setting balance).
    -   `utils.ts`: General-purpose helper functions (e.g., `cn` for classnames).
-   `src/config/`: Static configuration files.
    -   `game-config.ts`: The single source of truth for game parameters, including bet options, wheel segment definitions, game timings, and chip values.
-   `src/ai/`: Artificial Intelligence features using Genkit.
    -   `genkit.ts`: Initializes and configures the global Genkit instance.
    -   `flows/`: Contains Genkit flows. `ai-encouragement.ts` provides an example flow for generating contextual messages.
-   `src/types/`: TypeScript type definitions.
    -   `game.ts`: Defines the core data structures and types used throughout the application, such as `GameState`, `GameLogEntry`, `Bets`, etc.
    -   `user.ts`: Defines the `UserData` interface for documents stored in Firestore.
-   `public/`: Static assets served from the root.
    -   `asset-manifest.json`: A JSON file that catalogs all dynamic game assets (textures, images) to be loaded by the `AssetManager`.
-   `package.json`: Lists all project dependencies and defines run scripts (`dev`, `build`, `deploy`, etc.).

---

## 4. Core Game Logic (`src/app/game.tsx`)

The `game.tsx` component is the brain of the application. It uses a state machine-like approach to manage the game flow.

### State Management

-   `gameState`: A string literal type (`BETTING`, `SPINNING`, `RESULT`, etc.) that dictates the current phase of the game and what UI should be rendered.
-   `balance` & `setBalance`: The player's currency balance and the function to update it. This state is now managed by `AuthContext` to ensure it's globally accessible and can be persisted.
-   `bets`: An object storing the player's bet amount for each betting option in the current round.
-   `winningSegment`: The segment the wheel landed on after a spin.
-   `spinHistory`: An array of the last 7 winning segments for display.
-   `gameLog`: A detailed log of every spin, including bets, results, and bonus outcomes.
-   `countdown`: The timer for the betting phase.

### Game Loop

The game progresses through a defined sequence of states, primarily managed by `useEffect` hooks and `setTimeout` timers.

1.  **`BETTING`**: The default state. The `countdown` ticks down from `BETTING_TIME_SECONDS`. Players can place, undo, or clear bets. When the countdown reaches 0, it automatically triggers the `handleSpin` function.
2.  **`SPINNING`**: `handleSpin` is called. The Top Slot and Main Wheel animations are initiated. All betting controls are disabled. A timer is set for `SPIN_DURATION_SECONDS`.
3.  **`processSpinResult`**: After the spin timer completes, this function is called. It determines the outcome.
    -   If a **number** wins, the state changes to `NUMBER_RESULT`.
    -   If a **bonus** wins and the player bet on it, the state changes to `BONUS_[GAME_NAME]` (e.g., `BONUS_CASH_HUNT`).
    -   If a bonus wins but the player did *not* bet on it, the state goes directly to `RESULT`.
4.  **`NUMBER_RESULT` / `BONUS_*`**: These states render the respective popups or bonus game components. The bonus games are self-contained and use an `onComplete` callback to return the winnings to `game.tsx`.
5.  **`RESULT`**: A short intermediary state to show the final winnings before a new round starts. A timer is set for `RESULT_DISPLAY_SECONDS`.
6.  **`startNewRound`**: This function is called to reset all round-specific state (`bets`, `countdown`, etc.) and return the `gameState` to `BETTING`.

---

## 5. Component Implementation Details

-   **`Wheel`**: Rendered using SVG `<path>` elements for each segment. The rotation is handled by a single CSS `transform: rotate()` property on the SVG container, which is updated via React state. This is highly performant.
-   **`TopSlot`**: Simulates a reel spin by vertically translating a long strip of duplicated reel items using CSS `transform: translateY()`. A `cubic-bezier` timing function creates a realistic spin-and-settle effect.
-   **`BettingInterface`**: Features a "sundial" style chip selector that uses CSS transforms to position chips in an arc around the central button. The flying chip animation is achieved by creating a new chip element with `position: absolute` and animating its `transform` from the start coordinates (chip selector) to the end coordinates (betting option) using a CSS keyframe animation. The 4-way buttons trigger bets on four options at once.
-   **Bonus Game Components**: Each bonus game is a self-contained modal. It receives the `betAmount` and `onComplete` callback as props. It manages its own internal logic and animations and calls `onComplete(winnings, details)` when finished, returning control to the main `game.tsx` component.

---

## 6. Asset Management (`src/lib/asset-manager.ts`)

This system is designed to provide a fast, offline-first experience by caching image assets in the browser.

-   **Mechanism**: It uses `IndexedDB`, a robust client-side database, to store assets as `Blob`s.
-   **`asset-manifest.json`**: This file, located in `public/`, is the catalog of all game assets.
    -   `version`: A string (e.g., `"1.0.1"`). If this version changes, the `AssetManager` will automatically clear the old cache and download all assets fresh.
    -   `baseUrl`: The root URL for the assets. **This is critical.** To fetch assets from the JSDelivr CDN, this must be set to `"https://cdn.jsdelivr.net/gh/Appsmash89/spinriches-assets@main/"`. If left blank (`""`), the application will look for assets in the local `public/` directory instead.
    -   `assets`: An array of objects, each with a `key` (used to reference the asset in code) and a `path` (the file path relative to the `baseUrl`).
-   **Initialization Flow**: On the app's initial load (`/src/app/page.tsx`), `assetManager.init()` is called. It fetches the manifest, compares its version with the one stored in IndexedDB, and downloads any assets that are missing from the cache.
-   **Usage**: Components receive a map of asset keys to `Blob` URLs (e.g., `blob:http://...`) from the `assetManager`. These URLs are used directly in `<img>` `src` attributes or CSS `backgroundImage` properties.

---

## 7. Authentication and Data Persistence

### `auth-context.tsx`

Authentication is managed globally via a React Context. This context is also responsible for persisting user-specific data.

-   **Firebase Integration**: Uses the Firebase Web SDK (`firebase/auth`) for Google and GitHub popup-based sign-in.
-   **Data Persistence**: Uses Cloud Firestore to save and retrieve user data.
    -   **On Login**: When a user signs in, the context fetches their document from the `users/{userId}` collection in Firestore. If the document doesn't exist (i.e., a new user), it creates one with a default starting balance. The user's balance is then loaded into the context's state.
    -   **On Logout**: Before signing the user out, the context saves the current `balance` back to their Firestore document, ensuring their progress is not lost.
-   **Guest Mode**: A special mode implemented with a simple React state (`isGuest`). This allows users to play without creating an account. The `user` object is `null` and a default balance is used. No data is saved for guests.
-   **Error Handling**: The context specifically listens for common Firebase errors, such as `auth/unauthorized-domain` (when the app's domain isn't whitelisted in the Firebase console) and provides user-friendly error messages.

### `user-data-service.ts`

This service abstracts all direct communication with Firestore. It provides clean, reusable functions (`getUserData`, `saveUserData`, `createInitialUserData`) that the `AuthContext` uses. This separation of concerns makes the code cleaner and easier to maintain.

---

## 8. Styling and Theming

-   **Tailwind CSS**: Used for all utility-first styling.
-   **ShadCN/UI & CSS Variables**: The theme is defined in `src/app/globals.css`. It uses HSL-based CSS variables (e.g., `--primary`, `--background`, `--accent`) for colors. This makes it easy to change the entire application's color scheme by modifying a few lines of code. The dark theme is enabled by default on the `<html>` tag in `src/app/layout.tsx`.

---

## 9. Mobile Deployment (Capacitor)

The project is configured to be built as a native Android app.

-   `capacitor.config.ts`: Defines the app's ID, name, and tells Capacitor that the web assets are located in the `out/` directory (the output of `next build`).
-   **Build Process**: The scripts in `package.json` (`"build:android"`, `"android"`) streamline the process:
    1.  `npm run build`: Exports the Next.js app to static HTML/CSS/JS in the `out/` directory.
    2.  `npx cap sync android`: Copies these web assets into the native Android project and updates plugins.
    3.  `npx cap open android`: Opens the native project in Android Studio, from where it can be run on an emulator or a physical device.

---

## 10. Developer Notes & Don'ts

### Don'ts (Lessons Learned from Past Mistakes)

This section documents incorrect patterns that were previously attempted and should be avoided in future modifications to ensure a smooth and efficient development process.

1.  **Do Not Be Inconsistent with `asset-manifest.json`**: This file is the single source of truth for external assets.
    -   **File Formats**: Do not arbitrarily change asset file extensions unless specifically instructed. Maintain consistency across all asset paths.
    -   **`baseUrl`**: The `baseUrl` dictates the location of all assets. Do not change it without understanding the consequences. An empty `baseUrl` is for local development assets in `public/`, whereas a CDN URL is for production assets.

2.  **Avoid Unnecessary Back-and-Forth Changes**: Modifying a file, having the user correct it, and then changing it back is inefficient and frustrating. Ensure that any proposed change is well-understood, correct, and directly contributes to the user's request before generating the code.